---
# ansible v2.11
- name: Write device_facts into a csv file
  hosts: all
  gather_facts: true

  vars:
    output_path: "D://"
    filename: "device_report_{{ ansible_hostname }}.csv"

  tasks:
  - name: CSV - Generate output filename
    set_fact: date="{{lookup('pipe','date +%Y%m%d')}}"
    run_once: true

  - name: CSV - Create file and set the header
    lineinfile:
      dest: "{{ output_path }}/{{ filename }}"
      line:
        ansible_hostname,ansible_domain,ansible_fqdn,ansible_all_ipv4_addresses,ansible_distribution,ansible_machine,ansible_memtotal_mb
      create: yes
      state: present

  - name: CSV - Get devices facts
    set_fact:
      csv_tmp: >
        {{ ansible_hostname }},{{ ansible_domain }},{{ ansible_fqdn }},{{ ansible_all_ipv4_addresses }},{{ ansible_distribution }},{{ ansible_machine }},{{ ansible_memtotal_mb }}
  - name: CSV - Write information into .csv file
    lineinfile:
      insertafter: EOF
      dest: "{{ output_path }}/{{ filename }}"
      line: "{{ csv_tmp }}"

  - name: CSV - Blank lines removal
    lineinfile:
      path: "./{{ output_path }}/{{ filename }}"
      state: absent
      regex: '^\s*$'
